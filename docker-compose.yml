version: '3'

x-common-deploy: &common-deploy
  replicas: 1
  update_config:
    parallelism: 1
    delay: 30s
    failure_action: rollback
    monitor: 30s
    order: start-first
  rollback_config:
    parallelism: 1
    delay: 30s
    monitor: 60s

services:
  www:
    image: ghcr.io/theryangeary/www:latest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      services:

  mta-display:
    image: ghcr.io/theryangeary/mta-display:latest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      services:

  gl:
    image: ghcr.io/theryangeary/gl:v14
    deploy: *common-deploy
    restart: unless-stopped
    environment:
      - DATABASE_URL=sqlite:/data/grocery.db
      - PORT=3001
    volumes:
      - gl_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      services:

  gldemo:
    image: ghcr.io/theryangeary/gl:v14
    deploy: *common-deploy
    restart: unless-stopped
    environment:
      - DATABASE_URL=sqlite:/app/grocery.db
      - PORT=3001
      - GL_DEMO=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      services:

  pathfinder:
    image: ghcr.io/theryangeary/pathfinder:main
    env_file:
      - ./pathfinder/.env
    command: ["./cron_entrypoint.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - pathfinder_data:/data
    networks:
      services:

  cloudflared:
    image: cloudflare/cloudflared:1755-08efe4c10307
    command: tunnel --no-autoupdate run
    env_file:
      - .env
    restart: unless-stopped
    networks:
      cloudflared:

  volume_backup:
    image: ghcr.io/theryangeary/volume_backup:v3
    build:
      context: .
      dockerfile: volume_backup/Dockerfile
    restart: 'no'
    env_file:
      - .env
    environment:
      - FTP_PASSWORD_FILE=/run/secrets/homelab_ftp_password
    secrets:
      - homelab_ftp_password
    volumes:
      - gl_data:/data/gl
      - pathfinder_data:/data/pathfinder
      - deno_cache:/data/deno_cache
      - certmagic_cache:/data/certmagic_cache

  imageupdatewebhook:
    image: ghcr.io/theryangeary/image_update_webhook:v2
    build:
      context: ./image_update_webhook
      dockerfile: Dockerfile
    restart: 'unless-stopped'
    environment:
      - WEBHOOK_SECRET_FILE=/run/secrets/webhook_secret_green
    secrets:
      - webhook_secret_green
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    networks:
      services:

  authelia:
    image: 'docker.io/authelia/authelia:latest'
    restart: 'unless-stopped'
    networks:
      services:
    environment:
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE: '/run/secrets/authelia_jwt_secret'
      AUTHELIA_SESSION_SECRET_FILE: '/run/secrets/authelia_session_secret'
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: '/run/secrets/authelia_storage_encryption_key'
    configs:
      - source: authelia_config_blue
        target: /config/configuration.yml
      - source: authelia_users_green
        target: /config/users_database.yml
    secrets:
      - authelia_jwt_secret
      - authelia_session_secret
      - authelia_storage_encryption_key

  caddy:
    image: caddy:2.10
    restart: 'unless-stopped'
    networks:
      services:
      cloudflared:
    deploy: *common-deploy
    ports:
      - 80:80
      - 443:443
    volumes:
      - caddy_data:/data
    configs:
      - source: caddy_config_green
        target: /etc/caddy/Caddyfile

networks:
  services:
  cloudflared:
    name: cloudflared

volumes:
  deno_cache:
  certmagic_cache:
  gl_data:
  pathfinder_data:
  caddy_data:

secrets:
  homelab_ftp_password:
    external: true
  authelia_jwt_secret:
    external: true
  authelia_session_secret:
    external: true
  authelia_storage_encryption_key:
    external: true
  webhook_secret_green:
    external: true

configs:
  caddy_config_blue:
    external: true
  caddy_config_green:
    external: true
  authelia_config_blue:
    external: true
  authelia_config_green:
    external: true
  authelia_users_blue:
    external: true
  authelia_users_green:
    external: true
