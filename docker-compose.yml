version: '3'

x-common-deploy: &common-deploy
  replicas: 1
  update_config:
    parallelism: 1
    delay: 30s
    failure_action: rollback
    monitor: 30s
    order: start-first
  rollback_config:
    parallelism: 1
    delay: 30s
    monitor: 60s

services:
  gl:
    image: ghcr.io/theryangeary/gl:v10
    build:
      context: .
      dockerfile: gl/Dockerfile
    deploy: *common-deploy
    restart: unless-stopped
    environment:
      - DATABASE_URL=sqlite:/data/grocery.db
      - PORT=3001
    volumes:
      - gl_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      services:

  pathfinder:
    image: ghcr.io/theryangeary/pathfinder:latest
    environment:
      - RUST_LOG=info 
      - ALLOWED_ORIGINS=https://pathfinder-game.fly.dev,https://pathfinder.prof,https://pathfinder-game.fly.dev,http://pathfinder.localhost
      - REFERER_VALIDATION_ENABLED=true 
      - SESSION_TIMEOUT_MINUTES=1440 
      - RATE_LIMIT_PER_MINUTE=100 
      - SERVER_HOST=0.0.0.0
      - HTTP_PORT=8080
      - RATE_LIMIT_SESSION=10
      - RATE_LIMIT_READ=200
      - RATE_LIMIT_WRITE=50
      - RATE_LIMIT_WINDOW=60
      - COOKIE_MAX_AGE=31536000
      - REQUEST_TIMEOUT=30
      - MAX_REQUEST_SIZE=1048576
      - STRICT_REFERER="false"
      - HSTS_MAX_AGE=31536000
      - CORS_MAX_AGE=300
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      services:

  nginx:
    image: ghcr.io/theryangeary/nginx:v6
    build:
      context: .
      dockerfile: nginx/Dockerfile
    deploy: *common-deploy
    restart: unless-stopped
    depends_on:
      pathfinder:
        condition: service_healthy
      gl:
        condition: service_healthy
    networks:
      cloudflared:
      services:

  cloudflared:
    image: cloudflare/cloudflared:1755-08efe4c10307
    command: tunnel --no-autoupdate run
    env_file:
      - .env
    restart: unless-stopped
    networks:
      cloudflared:

  volume_backup:
    image: ghcr.io/theryangeary/volume_backup:v3
    build:
      context: .
      dockerfile: volume_backup/Dockerfile
    restart: 'no'
    env_file:
      - .env
    environment:
      - FTP_PASSWORD_FILE=/run/secrets/homelab_ftp_password
    secrets:
      - homelab_ftp_password
    volumes:
      - gl_data:/data/gl
      - deno_cache:/data/deno_cache
      - certmagic_cache:/data/certmagic_cache

networks:
  services:
  cloudflared:
    name: cloudflared

volumes:
  deno_cache:
  certmagic_cache:
  gl_data:

secrets:
  homelab_ftp_password:
    external: true
