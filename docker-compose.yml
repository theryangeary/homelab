version: '3'

x-common-deploy: &common-deploy
  replicas: 1
  update_config:
    parallelism: 1
    delay: 30s
    failure_action: rollback
    monitor: 60s
    order: start-first
  rollback_config:
    parallelism: 1
    delay: 30s
    monitor: 60s

services:
  smallweb:
    image: ghcr.io/theryangeary/smallweb:v2
    build:
      context: .
      dockerfile: smallweb/Dockerfile
    restart: unless-stopped
    command: up
    volumes:
      - ./smallweb:/smallweb
      - deno_cache:/home/ryan/.cache/deno
      - certmagic_cache:/home/ryan/.cache/certmagic
    networks:
      services:

  gl:
    image: ghcr.io/theryangeary/gl:v3
    build:
      context: .
      dockerfile: gl/Dockerfile
    deploy: *common-deploy
    restart: unless-stopped
    environment:
      - DATABASE_URL=sqlite:/data/grocery.db
      - PORT=3001
    volumes:
      - gl_data:/data
    networks:
      services:

  nginx:
    image: ghcr.io/theryangeary/nginx:v3
    build:
      context: .
      dockerfile: nginx/Dockerfile
    deploy: *common-deploy
    restart: unless-stopped
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      cloudflared:
      services:

  cloudflared:
    image: cloudflare/cloudflared:1755-08efe4c10307
    command: tunnel --no-autoupdate run
    env_file:
      - .env
    restart: unless-stopped
    networks:
      cloudflared:

networks:
  services:
  cloudflared:
    name: cloudflared

volumes:
  deno_cache:
  certmagic_cache:
  gl_data:
